name: ci

on:
  push:
  pull_request:
  schedule:
    - cron: "0 0 * * SUN"

jobs:
  build:
    strategy:
      fail-fast: false # Let the workflow continue as much as possible
      matrix:
        include:
          - os: windows-latest
            shell: bash
            lisp: sbcl-bin
            destination: cg.exe
          - os: ubuntu-latest
            shell: bash
            lisp: sbcl-bin
            destination: cg-linux
          - os: macos-latest
            shell: bash
            lisp: sbcl-bin
            destination: cg-osx
    defaults:
      run:
        shell: ${{ matrix.shell }}
    env:
      LISP: ${{ matrix.lisp }}
    name: build with ${{ matrix.lisp }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: iamFIREcracker/setup-lisp@windows-work
        with:
          roswell-version: v21.06.14.110
      - name: Update ql dist if we have one cached
        run: ros -e '(ql:update-all-dists :prompt nil)'
      - name: Set up caching for roswell files
        id: cache-dot-roswell
        uses: actions/cache@v1
        with:
          path: ~/.roswell
          key: ${{ runner.os }}-dot-roswell-${{ matrix.lisp }}-${{ hashFiles('**/*.asd') }}
          restore-keys: |
            ${{ runner.os }}-dot-roswell-${{ matrix.lisp }}-
            ${{ runner.os }}-dot-roswell-
      - uses: actions/checkout@v2
        with:
          # By default, this action would fetch a single commit only;
          # however, we are counting the number of commits since the "last tag"
          # inside build.lisp, and in order for that to work we have to figure
          # out a way to fetch all the ancestors of the current commit until we
          # land on the target tag...or we fetch all the history.
          #
          # Fetching the complete history will do just fine.
          fetch-depth: 0
      - name: Build the binary
        run: |
          make binary-ros
          mv bin/cg bin/${{ matrix.destination }}
      - name: Test loading of custom .cgrc
        run: |
          bin/${{ matrix.destination }} --version

          cat <<EOF > ~/.cgrc
          (cg:define-guesser echo
              ("(.+)" (cmd))
            (format NIL "~a" cmd))
          EOF
          bin/${{ matrix.destination }} --debug | grep ECHO
      - name: Upload the binary
        uses: actions/upload-artifact@v2
        with:
          name: binaries
          path: bin/${{ matrix.destination }}
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/download-artifact@v2
        with:
          name: binaries
          path: bin/
      - name: Extract release notes
        id: extract-release-notes
        uses: ffurrer2/extract-release-notes@v1
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
          tag_name: ${{ github.ref }}
          name: ${{ github.ref }}
          body: ${{ steps.extract-release-notes.outputs.release_notes }}
          files: bin/*
